<!DOCTYPE html>
<html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 8px;
      font-family: sans-serif;
    }
  
    input, button {
      font-size: 1.2rem;
      padding: 0.6rem;
      margin: 0.4rem 0;
      width: 100%;
      box-sizing: border-box;
    }
  
    #log {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      height: 500px; /* é«˜ã•ã‚¢ãƒƒãƒ— */
      overflow-y: scroll;
      white-space: pre-wrap;
      font-size: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      box-sizing: border-box;
      width: 100%;
    }
  
    img {
      width: 40px;
      height: 40px;
    }
  
    @media (min-width: 600px) {
      input, button {
        width: auto;
        font-size: 1rem;
      }
  
      #log {
        height: 300px;
        font-size: 0.9rem;
      }
  
      img {
        width: 50px;
        height: 50px;
      }
    }
  </style>
  <h1>Reality ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ãƒ†ã‚¹ãƒˆ</h1>

<label for="mediaId">é…ä¿¡IDï¼ˆmedia_idï¼‰:</label><br>
<input type="text" id="mediaId" placeholder="ä¾‹: "><br>
<button onclick="connectWebSocket()">æ¥ç¶š</button>
<button onclick="disconnectWebSocket()">åˆ‡æ–­</button>

<h2>ãƒ­ã‚°:</h2>
<div id="log" style="background: #fff; border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: scroll; white-space: pre-wrap; font-size: 1rem; line-height: 1.5; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);"></div>

<img id="loading-icon" src="https://reality.app/img/viewer/loading-icon.svg" alt="Loading" style="width: 50px; height: 50px; display: none; animation: spin 1s linear infinite;">
<img id="connecting-icon" src="https://reality.app/favicon.ico" alt="Connecting" style="width: 50px; height: 50px; display: none;">
<img id="connected-icon" src="https://reality.app/favicon.ico" alt="Connected" style="width: 50px; height: 50px; display: none;">

<script>
  let ws;

  function log(message) {
    const logBox = document.getElementById("log");
    logBox.textContent += message + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  function logComment(nickname, comment, icon_url) {
    const logBox = document.getElementById("log");

    const wrapper = document.createElement("div");
    wrapper.className = "comment-wrapper";
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "flex-start";
    wrapper.style.gap = "10px";
    wrapper.style.marginBottom = "10px";

    const icon = document.createElement("img");
    icon.className = "icon";
    icon.src = icon_url;
    icon.alt = nickname;
    icon.style.width = "40px";
    icon.style.height = "40px";
    icon.style.borderRadius = "50%";
    icon.style.objectFit = "cover";
    icon.onerror = () => {
      icon.src = "https://reality.app/favicon.ico";
    };

    const content = document.createElement("div");
    content.className = "comment-content";
    content.style.background = "#f9f9f9";
    content.style.padding = "0.4em 0.6em";
    content.style.borderRadius = "8px";
    content.style.border = "1px solid #ddd";

    const nameEl = document.createElement("div");
    nameEl.className = "nickname";
    nameEl.style.fontWeight = "bold";
    nameEl.textContent = nickname;

    const textEl = document.createElement("div");
    textEl.className = "text";
    textEl.style.marginTop = "2px";
    textEl.textContent = comment;

    content.appendChild(nameEl);
    content.appendChild(textEl);

    wrapper.appendChild(icon);
    wrapper.appendChild(content);
    logBox.appendChild(wrapper);

    logBox.scrollTop = logBox.scrollHeight;
  }

  function extractMediaIdFromUrl(url) {
    const match = url.match(/(viewer\/|next_reality_viewer\/)(\d{9})/);
    return match ? match[2] : null;
  }

  function connectWebSocket() {
    const mediaId = document.getElementById("mediaId").value.trim();
    if (!mediaId) {
      log("âš ï¸ media_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const url = `wss://comment.reality.app/?media_id=${mediaId}`;
    log(`ğŸ”— WebSocketæ¥ç¶šä¸­: ${url}`);

    document.getElementById("loading-icon").style.display = "block";
    document.getElementById("connecting-icon").style.display = "none";
    document.getElementById("connected-icon").style.display = "none";

    ws = new WebSocket(url);

    ws.onopen = () => {
      log("âœ… æ¥ç¶šæˆåŠŸï¼");
      document.getElementById("loading-icon").style.display = "none";
      document.getElementById("connecting-icon").style.display = "none";
      document.getElementById("connected-icon").style.display = "block";
    };

    ws.onmessage = (event) => {
      try {
        const json = JSON.parse(event.data);
        console.log("ğŸ“„ ãƒ‘ãƒ¼ã‚¹å¾Œã®ãƒ‡ãƒ¼ã‚¿:", json);

        if (json && json.content && json.nickname) {
          const nickname = json.nickname;
          const comment = json.content;
          const icon_url = json.icon_url || "https://reality.app/favicon.ico";
          logComment(nickname, comment, icon_url);
        } else {
          console.log("ğŸ’¤ ç„¡è¦–ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:", json);
        }
      } catch (e) {
        console.log("âŒ JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—:", event.data);
      }
    };

    ws.onerror = (error) => {
      log("âŒ ã‚¨ãƒ©ãƒ¼: " + error);
    };

    ws.onclose = () => {
      log("ğŸ”Œ æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
      document.getElementById("connecting-icon").style.display = "block";
      document.getElementById("loading-icon").style.display = "none";
      document.getElementById("connected-icon").style.display = "none";
    };
  }

  function disconnectWebSocket() {
    if (ws) {
      ws.close();
      log("ğŸšª æ‰‹å‹•ã§åˆ‡æ–­ã—ã¾ã—ãŸ");
    }
    document.getElementById("mediaId").value = "";
  }

  document.getElementById("mediaId").addEventListener("input", function () {
    const url = this.value.trim();
    const mediaId = extractMediaIdFromUrl(url);

    if (!mediaId) {
      fetchExpandedUrl(url).then(expandedUrl => {
        const expandedMediaId = extractMediaIdFromUrl(expandedUrl);
        if (expandedMediaId) {
          this.value = expandedMediaId;
        }
      });
    } else {
      this.value = mediaId;
    }
  });

  async function fetchExpandedUrl(shortUrl) {
    try {
      const response = await fetch(`https://api.shrtco.de/v2/expand?url=${encodeURIComponent(shortUrl)}`);
      const data = await response.json();
      if (data.ok) {
        return data.result.full_link;
      } else {
        log("âŒ çŸ­ç¸®URLã®å±•é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return shortUrl;
      }
    } catch (error) {
      log("âŒ ã‚¨ãƒ©ãƒ¼: " + error);
      return shortUrl;
    }
  }
</script>
</html>
